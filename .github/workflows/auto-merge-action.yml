name: Auto-merge valid Action.json PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Validate, merge, or close PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const allowedActions = ["UP", "DOWN", "LEFT", "RIGHT", "SHOOT"];
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;

            async function commentAndClose(reason) {
              core.info(`‚ùå Closing PR #${prNumber}: ${reason}`);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è This PR was automatically closed.\n\n**Reason:** ${reason}`
              });
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                state: "closed"
              });
            }

            if (pr.draft) {
              await commentAndClose("PR is a draft. Please mark it as ready for review.");
              return;
            }

            // --- 1Ô∏è‚É£ Check changed files ---
            const files = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber,
            });

            if (files.data.length !== 1 || files.data[0].filename !== "Actions/Action.json") {
              await commentAndClose("Only 'Actions/Action.json' can be modified in this PR.");
              return;
            }

            // --- 2Ô∏è‚É£ Validate JSON content ---
            const raw_url = files.data[0].raw_url;
            const res = await fetch(raw_url);
            const text = await res.text();

            let data;
            try {
              data = JSON.parse(text);
            } catch (err) {
              await commentAndClose("Invalid JSON format in 'Actions/Action.json'.");
              return;
            }

            const { action } = data;
            if (!allowedActions.includes(action)) {
              await commentAndClose(
                `Invalid action '${action}'. Must be one of: ${allowedActions.join(", ")}.`
              );
              return;
            }

            // --- 3Ô∏è‚É£ Create a new branch and commit ---
            const username = pr.user.login;
            const branchName = `auto-pr-${username}`;

            // Get the default branch (usually main)
            const { data: repoData } = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoData.default_branch;

            // Get SHA of default branch
            const { data: refData } = await github.rest.git.getRef({
              owner,
              repo,
              ref: `heads/${defaultBranch}`,
            });
            const baseSha = refData.object.sha;

            // Create new branch
            try {
              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/heads/${branchName}`,
                sha: baseSha,
              });
              core.info(`‚úÖ Created branch '${branchName}'`);
            } catch (err) {
              core.warning(`‚ö†Ô∏è Branch '${branchName}' might already exist: ${err.message}`);
            }

            // Update file in new branch
            const fileSha = files.data[0].sha;
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: "Actions/Action.json",
              message: `Update Action.json via auto-merge`,
              content: Buffer.from(JSON.stringify(data, null, 2)).toString('base64'),
              branch: branchName,
              sha: fileSha
            });

            // --- 4Ô∏è‚É£ Create a PR to default branch ---
            await github.rest.pulls.create({
              owner,
              repo,
              head: branchName,
              base: defaultBranch,
              title: `Auto PR from ${username}`,
              body: `This PR was created automatically from ${username}'s action.`,
            });

            core.info(`‚úÖ Pull request created from branch '${branchName}'`);

            // --- 5Ô∏è‚É£ Send POST to server ---
            const payload = JSON.stringify({ username, action });
            const serverUrl = process.env.ACTION_SERVER_URL;

            try {
              const postRes = await fetch(serverUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: payload,
              });
              core.info(`üåê POST to server: ${postRes.status} ${postRes.statusText}`);
            } catch (err) {
              core.warning(`‚ö†Ô∏è Failed to send POST to server: ${err.message}`);
            }
        env:
          ACTION_SERVER_URL: ${{ secrets.ACTION_SERVER_URL }}
